<?xml version="1.0" encoding="UTF-8"?>
<process
    name="autopayPaymentKCELL"
    targetNamespace="http://enterprise.netbeans.org/bpel/AutoPayPaymentBPEL/autopayPaymentKCELL"
    xmlns:tns="http://enterprise.netbeans.org/bpel/AutoPayPaymentBPEL/autopayPaymentKCELL"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
    xmlns:sxt="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Trace" 
    xmlns:sxed="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Editor"
    xmlns:sxeh="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/ErrorHandling" xmlns:sxed2="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Editor2" xmlns:ns0="http://xml.kaspibank.kz/schema/autopay" xmlns:ns1="http://j2ee.netbeans.org/xsd/tableSchema" xmlns:sxnmp="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/NMProperty" xmlns:sxxf="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/XPathFunctions">
    <import namespace="http://j2ee.netbeans.org/wsdl/AutoPayPaymentBPEL/recieveKCELLPaymentFromQUEUE" location="recieveKCELLPaymentFromQUEUE.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://j2ee.netbeans.org/wsdl/AutoPayPaymentBPEL/EXEC_PAY" location="EXEC_PAY.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://xml.kaspibank.kz/schema/autopay" location="autopay.xsd" importType="http://www.w3.org/2001/XMLSchema"/>
    <import namespace="http://j2ee.kaspibank.kz/wsdl/AutoPayPaymentBPEL/sendKCELLResultToQueue" location="sendKCELLResultToQueue.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <partnerLinks>
        <partnerLink name="execPay" xmlns:tns="http://j2ee.netbeans.org/wsdl/AutoPayPaymentBPEL/EXEC_PAY" partnerLinkType="tns:jdbcpartner" partnerRole="jdbcPortTypeRole"/>
        <partnerLink name="sendResult" xmlns:tns="http://j2ee.kaspibank.kz/wsdl/AutoPayPaymentBPEL/sendKCELLResultToQueue" partnerLinkType="tns:sendKCELLResultToQueue" partnerRole="JMSOutPortTypeRole"/>
        <partnerLink name="receiveFromQueue" xmlns:tns="http://j2ee.netbeans.org/wsdl/AutoPayPaymentBPEL/recieveKCELLPaymentFromQUEUE" partnerLinkType="tns:recieveKCELLPaymentFromQUEUE" myRole="JMSInPortTypeRole"/>
    </partnerLinks>
    <variables>
        <variable name="DATABASE_AVAILABLE" type="xs:boolean"/>
        <variable name="SendResultRequest" xmlns:tns="http://j2ee.kaspibank.kz/wsdl/AutoPayPaymentBPEL/sendKCELLResultToQueue" messageType="tns:JMSInputMessage"/>
        <variable name="ExecPayResult" xmlns:tns="http://j2ee.netbeans.org/wsdl/AutoPayPaymentBPEL/EXEC_PAY" messageType="tns:outputMsg"/>
        <variable name="ExecPayRequest" xmlns:tns="http://j2ee.netbeans.org/wsdl/AutoPayPaymentBPEL/EXEC_PAY" messageType="tns:inputMsg"/>
        <variable name="paymentRequest" xmlns:tns="http://j2ee.netbeans.org/wsdl/AutoPayPaymentBPEL/recieveKCELLPaymentFromQUEUE" messageType="tns:JMSInputMessage"/>
    </variables>
    <sequence>
        <receive name="Receive1" createInstance="yes" partnerLink="receiveFromQueue" operation="JMSInOperation" xmlns:tns="http://j2ee.netbeans.org/wsdl/AutoPayPaymentBPEL/recieveKCELLPaymentFromQUEUE" portType="tns:JMSInPortType" variable="paymentRequest"></receive>
        <assign name="Assign1">
            <documentation>1. мапинг переменных для вызова хранимой процедуры EXEP_PAY
2. установка селектора для результатного JMS сообщения</documentation>
            <copy>
                <from>$paymentRequest.part1/ns0:phone</from>
                <to>$ExecPayRequest.part/ns1:CIN_PHONE_NUMBER</to>
            </copy>
            <copy>
                <from>$paymentRequest.part1/ns0:brand</from>
                <to>$ExecPayRequest.part/ns1:CIN_BRAND</to>
            </copy>
            <copy>
                <from>true()</from>
                <to>$ExecPayRequest.part/ns1:NIN_SUM_PAY/@isNull</to>
            </copy>
            <copy>
                <from>'OUT'</from>
                <to variable="SendResultRequest" sxnmp:nmProperty="org.glassfish.openesb.jms.userproperties.DIRECTION"/>
            </copy>
            <copy>
                <from>'KCELL'</from>
                <to variable="SendResultRequest" sxnmp:nmProperty="org.glassfish.openesb.jms.userproperties.OPERATOR"/>
            </copy>
            <copy>
                <from>true()</from>
                <to variable="DATABASE_AVAILABLE"/>
            </copy>
        </assign>
        <scope name="Scope1">
            <faultHandlers>
                <catch faultName="sxeh:systemFault" faultVariable="DatabaseFault" faultMessageType="sxeh:faultMessage">
                    <sequence name="Sequence2">
                        <assign name="Assign4">
                            <copy>
                                <from>'ERROR'</from>
                                <to>$SendResultRequest.result/ns0:code</to>
                            </copy>
                            <copy>
                                <from>'SINR'</from>
                                <to>$SendResultRequest.result/ns0:message</to>
                            </copy>
                            <copy>
                                <from>false()</from>
                                <to variable="DATABASE_AVAILABLE"/>
                            </copy>
                            <copy>
                                <from>$paymentRequest.part1/ns0:phone</from>
                                <to>$SendResultRequest.result/ns0:phone</to>
                            </copy>
                            <copy>
                                <from>$paymentRequest.part1/ns0:transactionId</from>
                                <to>$SendResultRequest.result/ns0:transactionId</to>
                            </copy>
                        </assign>
                    </sequence>
                </catch>
            </faultHandlers>
            <invoke name="Invoke1" partnerLink="execPay" operation="execute" xmlns:tns="http://j2ee.netbeans.org/wsdl/AutoPayPaymentBPEL/EXEC_PAY" portType="tns:jdbcPortType" inputVariable="ExecPayRequest" outputVariable="ExecPayResult">
                <sxt:trace>
                        <sxt:log level="severe" location="onComplete">
                                <from variable="ExecPayResult" part="part"/>
                            </sxt:log>
                    </sxt:trace>
            </invoke>
        </scope>
        <if name="If2">
            <documentation>если база даных доступна</documentation>
            <condition>$DATABASE_AVAILABLE</condition>
            <if name="If1">
                <condition>'OK' = $ExecPayResult.part/ns1:COUT_RESULT</condition>
                    <sequence name="Sequence1">
                        <assign name="Assign2">
                                <copy>
                                        <from>'OK'</from>
                                            <to>$SendResultRequest.result/ns0:code</to>
                                    </copy>
                                    <copy>
                                        <from>$paymentRequest.part1/ns0:transactionId</from>
                                            <to>$SendResultRequest.result/ns0:transactionId</to>
                                    </copy>
                                    <copy>
                                        <from>$paymentRequest.part1/ns0:phone</from>
                                            <to>$SendResultRequest.result/ns0:phone</to>
                                    </copy>
                            </assign>
                    </sequence>
                    <else>
                        <assign name="Assign3">
                                <copy>
                                        <from>'ERROR'</from>
                                            <to>$SendResultRequest.result/ns0:code</to>
                                    </copy>
                                    <copy>
                                        <from>'ERROR'</from>
                                            <to>$SendResultRequest.result/ns0:message</to>
                                    </copy>
                                    <copy>
                                        <from>$paymentRequest.part1/ns0:phone</from>
                                            <to>$SendResultRequest.result/ns0:phone</to>
                                    </copy>
                                    <copy>
                                        <from>$paymentRequest.part1/ns0:transactionId</from>
                                            <to>$SendResultRequest.result/ns0:transactionId</to>
                                    </copy>
                            </assign>
                    </else>
            </if>
        </if>
        <invoke name="Invoke2" partnerLink="sendResult" operation="JMSOutOperation" xmlns:tns="http://j2ee.kaspibank.kz/wsdl/AutoPayPaymentBPEL/sendKCELLResultToQueue" portType="tns:JMSOutPortType" inputVariable="SendResultRequest">
            <sxt:trace>
                <sxt:log level="severe" location="onStart">
                    <from variable="SendResultRequest" part="result"/>
                </sxt:log>
            </sxt:trace>
        </invoke>
    </sequence>
</process>



















